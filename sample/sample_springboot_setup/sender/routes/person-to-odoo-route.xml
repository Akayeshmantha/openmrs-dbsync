<routes xmlns="http://camel.apache.org/schema/spring">
  <route id="person-to-odoo">
    <from uri="direct:person-to-odoo"/>
    <log message="${body}"/>
    <setProperty propertyName="openmrs-person-uuid">
      <jsonpath>$.model.uuid</jsonpath>
    </setProperty>
    <enrich strategyRef="setOdooIdToPropertyAggregationStrategy">
      <simple>sql:select o.odoo_id from odoo_open_mrs_id_mapping o where o.patient_uuid='${property.openmrs-person-uuid}'?dataSource=#mngtDataSource</simple>
    </enrich>
    <transform>
      <jsonpath>$.model.['birthdate','gender']</jsonpath>
    </transform>
    <transform>
      <jsonpath>$.[*]</jsonpath>
    </transform>
    <setProperty propertyName="patient-data">
      <constant/>
    </setProperty>
    <choice>
      <when>
        <simple>${body[0]} != null</simple>
        <setProperty propertyName="patient-data">
          <simple>date_of_birth=${body[0][0]}-${body[0][1]}-${body[0][2]}&amp;</simple>
        </setProperty>
      </when>
    </choice>
    <choice>
      <when>
        <simple>${body[1]} == 'M'</simple>
        <setProperty propertyName="patient-data">
          <simple>${property.patient-data}gender=male</simple>
        </setProperty>
      </when>
      <when>
        <simple>${body[1]} == 'F'</simple>
        <setProperty propertyName="patient-data">
          <simple>${property.patient-data}gender=female</simple>
        </setProperty>
      </when>
    </choice>
    <choice>
      <when>
        <simple>${property.odoo-person-id} == null</simple>
        <transform>
          <simple>name=[Unknown]&amp;${property.patient-data}</simple>
        </transform>
      </when>
      <otherwise>
        <setBody>
          <simple>${property.patient-data}</simple>
        </setBody>
      </otherwise>
    </choice>
    <setBody>
      <simple>{"endpoint":"res.partner","url":"in_outpatient=inpatient&amp;${body}"}</simple>
    </setBody>
    <unmarshal>
      <json library="Jackson"/>
    </unmarshal>
    <log message="${body}"/>
    <to uri="direct:odoo-route"/>
  </route>
</routes>
